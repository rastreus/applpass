name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.2.3"

      - name: Build and verify
        run: |
          swift --version
          swift build --disable-sandbox
          swift test --disable-sandbox --verbose
          if swift format --help >/dev/null 2>&1; then
            swift format lint --recursive Sources/ Tests/
          else
            swift run --disable-sandbox swift-format lint --recursive Sources/ Tests/
          fi
          swift build -c release --disable-sandbox

      - name: Package release archive
        run: |
          mkdir -p dist
          cp ".build/release/applpass" dist/applpass
          tar -C dist -czf "dist/applpass-${GITHUB_REF_NAME}-macos-arm64.tar.gz" applpass
          shasum -a 256 "dist/applpass-${GITHUB_REF_NAME}-macos-arm64.tar.gz" > "dist/applpass-${GITHUB_REF_NAME}-macos-arm64.sha256"

      - name: Extract changelog entry
        run: |
          version="${GITHUB_REF_NAME#v}"
          awk -v target="$version" '
            $0 ~ "^## \\[" target "\\]" {capture=1; next}
            capture && $0 ~ "^## \\[" {exit}
            capture {print}
          ' CHANGELOG.md > dist/release-notes.md

          if [ ! -s dist/release-notes.md ]; then
            printf "Release %s\n\nNo changelog entry found for version %s.\n" "$GITHUB_REF_NAME" "$version" > dist/release-notes.md
          fi

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: applpass-${{ github.ref_name }}-macos-arm64
          path: |
            dist/applpass-${{ github.ref_name }}-macos-arm64.tar.gz
            dist/applpass-${{ github.ref_name }}-macos-arm64.sha256

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          name: applpass ${{ github.ref_name }}
          body_path: dist/release-notes.md
          files: |
            dist/applpass-${{ github.ref_name }}-macos-arm64.tar.gz
            dist/applpass-${{ github.ref_name }}-macos-arm64.sha256
