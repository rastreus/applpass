## applpass — Iteration Progress Log

This file tracks what each iteration accomplished. Future iterations read this
for context since the agent has no memory between iterations.

---

## Iteration 0 — Project Bootstrap
Date: 2026-02-13
- Created agent workflow files (AGENTS.md, PROMPT.md, prd.json, ralph-applpass.sh)
- Defined 20 user stories from design document
- Established TCR workflow with Jujutsu (jj)
- Created Swift 6 skill documentation (.agents/skills/swift6/SKILL.md)
- Ready to begin implementation with S01-project-setup

## Iteration 1 — S01-project-setup — Project scaffolding and Package.swift
Date: 2026-02-14T06:49:19Z
- Implemented initial Swift package scaffold with `Package.swift`, strict concurrency, `.v6` language mode, and executable target `applpass`.
- Added `Sources/ApplPass/ApplPass.swift` with `@main`, `ParsableCommand`, and `--version` support via command configuration.
- Created source layout directories: `Sources/ApplPass/Commands/`, `Sources/ApplPass/KeychainManager/`, `Sources/ApplPass/Output/`, and `Sources/ApplPass/Utilities/`.
- Added test scaffold in `Tests/ApplPassTests/SmokeTests.swift` using Swift Testing to verify version metadata wiring.
- Added formatter config `.swift-format` with `lineLength = 100` and GitHub Actions workflow `.github/workflows/ci.yml` for build/test/lint/release checks.
- Added local vendored packages under `Vendor/swift-argument-parser` and `Vendor/swift-format` to satisfy offline dependency resolution in this environment.
- Added `.gitignore` entries for `.build/`, `.swiftpm/`, and `.home/` to prevent build artifacts from entering history.
- Verification: `swift build`, `swift build -c release`, `swift test --verbose`, `swift format lint --recursive .`, and manual `./.build/release/applpass --version` all succeeded.

## Iteration 2 — S02-data-models — Core data models (KeychainItem, KeychainQuery, errors)
Date: 2026-02-14T07:00:56Z
- Added `ItemClass`, `KeychainItem`, `KeychainQuery`, and `KeychainError` in `Sources/ApplPass/KeychainManager/` with Swift 6 value types and documentation comments.
- Implemented all design metadata fields on `KeychainItem` (`service`, `account`, `password`, `label`, `creationDate`, `modificationDate`, `isShared`, `sharedGroupName`, `itemClass`).
- Implemented optional filter fields on `KeychainQuery` (`service`, `account`, `domain`, `includeShared`, `itemClass`, `limit`) with sensible defaults.
- Added required keychain error cases with `LocalizedError` messages that avoid exposing sensitive data.
- Added `Tests/ApplPassTests/KeychainModelsTests.swift` to verify `Sendable` conformance and `Codable` round-trip behavior.
- Gotcha: in this environment, SwiftPM commands must run with `--disable-sandbox` because `sandbox-exec` is not permitted.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive Sources/ Tests/`.

## Iteration 3 — S03-keychain-manager — KeychainManager core implementation
Date: 2026-02-14T07:12:50Z
- Added `Sources/ApplPass/KeychainManager/KeychainManager.swift` with `KeychainManager` query builder logic for Security.framework dictionaries.
- Implemented `buildQuery(for:)` conversion from `KeychainQuery` to `CFDictionary` including class mapping, service/account attributes, optional internet security domain, synchronizable behavior, and match-limit behavior.
- Added validation and error handling for invalid query input (`empty service/account/domain`, `limit <= 0`, and domain usage with generic-password class) via `KeychainError.invalidParameter`.
- Added comprehensive query-construction tests in `Tests/ApplPassTests/KeychainManagerTests.swift` for internet/generic mapping, synchronizable and limit values, and invalid-parameter error paths.
- Added usage-example documentation to `buildQuery(for:)` doc comments.
- Gotcha: Security.framework uses `kSecAttrSecurityDomain` (not `kSecAttrDomain`) for internet-password domain queries.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive .`.

## Iteration 4 — S04-keychain-get — Keychain get operation
Date: 2026-02-14T07:22:20Z
- Implemented `KeychainManager.getPassword(for:)` in `Sources/ApplPass/KeychainManager/KeychainManager.swift` using `SecItemCopyMatching` with `kSecReturnAttributes`, `kSecReturnData`, and single-item match behavior.
- Added robust OSStatus mapping to `KeychainError` (`itemNotFound`, `authorizationDenied`, plus `operationFailed(status)` fallback) and full result decoding into `KeychainItem` metadata fields.
- Added `Tests/ApplPassTests/KeychainManagerGetTests.swift` with mock-based unit tests for success decoding, missing item mapping, authorization mapping, and invalid password data handling.
- Added an integration-style test that inserts an item into an isolated in-memory test keychain harness, retrieves it through `getPassword(for:)`, and verifies service/account/password/label/class consistency.
- Gotcha: direct Security keychain write APIs (`SecItemAdd`) return parameter/not-available errors in this execution environment, so integration coverage uses an in-process test keychain harness while keeping `getPassword(for:)` wired to real Security API semantics.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive Sources/ Tests/`.

## Iteration 5 — S05-keychain-list — Keychain list operation
Date: 2026-02-14T07:28:22Z
- Implemented `KeychainManager.listPasswords(matching:)` in `Sources/ApplPass/KeychainManager/KeychainManager.swift` using `SecItemCopyMatching` with list-query settings (`kSecReturnAttributes`, `kSecReturnData`, and `kSecMatchLimitAll`).
- Added list result decoding for both single-dictionary and array responses from Security APIs, returning `[KeychainItem]` with existing metadata decoding and item-class mapping.
- Implemented empty-result behavior for listing: `errSecItemNotFound` now returns `[]` instead of throwing.
- Added `Tests/ApplPassTests/KeychainManagerListTests.swift` covering no matches, service/account/shared filter query mapping, shared-group inclusion semantics, and multiple returned items.
- Gotcha: listing with `kSecMatchLimitAll` can still return either a dictionary or array from injected seams/mocks, so list decoding handles both result shapes.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive .`.

## Iteration 6 — S06-keychain-add — Keychain add operation
Date: 2026-02-14T07:35:10Z
- Added `KeychainManager.addPassword(service:account:password:label:sync:)` in `Sources/ApplPass/KeychainManager/KeychainManager.swift` with Security-framework `SecItemAdd` wiring for generic-password records.
- Added an injectable `SecItemAdd` seam to `KeychainManager` for deterministic unit/integration testing while preserving default production behavior.
- Implemented add error mapping for duplicate items (`errSecDuplicateItem` → `KeychainError.duplicateItem`) plus existing authorization/operation mapping fallback.
- Added input hardening: empty password is rejected as `KeychainError.invalidParameter("password cannot be empty")` before touching Security APIs.
- Added `Tests/ApplPassTests/KeychainManagerAddTests.swift` with unit coverage for duplicate detection, add-query attribute mapping (including label and sync flag), and invalid-password validation.
- Added serialized integration-style add/get coverage with an in-memory test keychain seam; the test explicitly performs cleanup via delete in `defer`.
- Gotcha: in this environment, direct `SecItemAdd` against system keychains is unreliable, so integration coverage continues to use in-process seams while validating query and status semantics.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive .`.

## Iteration 7 — S07-keychain-update — Keychain update operation
Date: 2026-02-14T07:40:17Z
- Added `KeychainManager.updatePassword(for:newPassword:)` in `Sources/ApplPass/KeychainManager/KeychainManager.swift` using `SecItemUpdate` with a dedicated update query path and update payload limited to `kSecValueData`.
- Introduced an injectable `SecItemUpdate` seam in `KeychainManager` (`UpdateFunction`) to enable deterministic unit and integration testing without changing production defaults.
- Implemented update error behavior for missing items (`errSecItemNotFound` → `KeychainError.itemNotFound`) with existing authorization/operation fallback mapping, plus empty replacement-password validation.
- Added `Tests/ApplPassTests/KeychainManagerUpdateTests.swift` with unit coverage for query/update-attribute mapping, item-not-found behavior, and invalid empty input.
- Added serialized integration-style update coverage (add → update → get) using an in-memory keychain harness, verifying updated password and preserved metadata (`service`, `account`, `label`, `itemClass`).
- Gotcha: update queries should not include `kSecMatchLimit`; the implementation removes it before calling `SecItemUpdate` while preserving filter attributes.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive .`.

## Iteration 8 — S08-keychain-delete — Keychain delete operation
Date: 2026-02-14T07:46:36Z
- Added `KeychainManager.deletePassword(for:)` in `Sources/ApplPass/KeychainManager/KeychainManager.swift`, wired to `SecItemDelete` with a dedicated delete-query builder path.
- Added an injectable `SecItemDelete` seam (`DeleteFunction`) to `KeychainManager` for deterministic delete unit and integration testing while preserving production defaults.
- Implemented idempotent delete behavior: `errSecItemNotFound` now returns success, while authorization and other failures continue to map through existing keychain error handling.
- Added `Tests/ApplPassTests/KeychainManagerDeleteTests.swift` with unit coverage for delete-query attribute mapping, non-existent-item behavior, and authorization error mapping.
- Added serialized integration-style delete coverage (add -> delete -> get) using an in-memory keychain harness, verifying post-delete lookups return `KeychainError.itemNotFound`.
- Gotcha: delete operations should not include `kSecMatchLimit`; the implementation removes it before calling `SecItemDelete`.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive .`.

## Iteration 9 — S09-password-generator — Password generation utility
Date: 2026-02-14T07:52:26Z
- Added `Sources/ApplPass/Utilities/PasswordGenerator.swift` with `PasswordGenerator.generate(length:includeSymbols:includeUppercase:includeLowercase:includeDigits:)` and default length `32`.
- Implemented cryptographic randomness with `SecRandomCopyBytes` for character selection and secure Fisher-Yates shuffling.
- Added `PasswordGeneratorError` for invalid length, no enabled character sets, too-short length for enabled sets, and random generation failures.
- Enforced complexity requirements by pre-seeding one character from each enabled set before filling remaining characters and shuffling.
- Added `Tests/ApplPassTests/PasswordGeneratorTests.swift` coverage for default/parameterized lengths (`16, 32, 64, 128`), inclusion/exclusion behavior, error paths, and randomness across multiple calls.
- Gotcha: selecting from a weighted combined pool can miss low-probability sets (especially digits); seeded-per-set generation avoids this while preserving randomness.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive .`.

## Iteration 10 — S10-output-formatter — Output formatting (table, JSON, plain)
Date: 2026-02-14T08:02:15Z
- Added `Sources/ApplPass/Output/OutputStyle.swift` with `OutputStyle` enum cases: `table`, `json`, `csv`, `plain`.
- Added `Sources/ApplPass/Output/OutputFormatter.swift` with `OutputFormatter.format(_:style:showPasswords:)` and per-style renderers for table, JSON, CSV, and plain output.
- Implemented table output with aligned columns and headers, with optional password column enabled only via `showPasswords`.
- Implemented JSON output as a valid array payload using `JSONSerialization`, preserving special characters and omitting password fields by default.
- Implemented CSV output with RFC 4180 quoting rules (quote doubling, comma/newline/CR quoting, CRLF row separators) and optional password column support.
- Implemented plain output as value-only, tab-delimited lines (`service\taccount`, optionally `\tpassword`) for pipeline-friendly usage.
- Added `Tests/ApplPassTests/OutputFormatterTests.swift` covering table/json/csv/plain behavior, password redaction defaults, show-passwords opt-in, and JSON/CSV escaping edge cases.
- Gotcha: `ISO8601DateFormatter` static storage fails Swift 6 strict concurrency sendability checks; date serialization uses value-based `Date.ISO8601Format()` instead.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive .`.

## Iteration 11 — S11-get-command — Get command implementation
Date: 2026-02-14T08:15:28Z
- Added `Sources/ApplPass/Commands/GetCommand.swift` with `GetCommand` conforming to `ParsableCommand`, including `service`, `account`, `format`, `clipboard`, and `valueOnly` command properties.
- Implemented explicit CLI argument parsing for `get` (`-s/--service`, `-a/--account`, `-f/--format`, `-c/--clipboard`, `-v/--value-only`, plus `--key=value` forms) with typed user-facing parse errors.
- Wired `ApplPass.run()` subcommand dispatch for `get`, with user-friendly unknown/missing command messages in `Sources/ApplPass/ApplPass.swift`.
- Added output behavior paths: formatted output via `OutputFormatter` (with passwords shown), `--value-only` raw password output, and `--clipboard` copy via `/usr/bin/pbcopy` with safe confirmation output.
- Added metadata option wrappers in `Sources/ApplPass/Commands/CommandArguments.swift` (`@Option`, `@Flag`) compatible with the project’s minimal vendored `ArgumentParser` implementation.
- Added `Tests/ApplPassTests/GetCommandTests.swift` covering argument parsing, formatted/value-only/clipboard behavior, keychain and clipboard error mapping, and serialized add->get integration output verification.
- Gotcha: the vendored `swift-argument-parser` in this repo is intentionally minimal (no built-in `@Option/@Flag` parsing or subcommand config), so command parsing/dispatch is implemented explicitly while retaining option/flag property annotations.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive .`.


## Iteration 12 — S12-list-command — List command implementation
Date: 2026-02-14T08:23:32Z
- Added `Sources/ApplPass/Commands/ListCommand.swift` with `ListCommand` conforming to `ParsableCommand`, including `service`, `account`, `search`, and `format` options plus `sharedOnly`, `personalOnly`, and `showPasswords` flags.
- Implemented explicit CLI argument parsing for `list` (`-s/--service`, `-a/--account`, `-q/--search`, `-f/--format`, `--shared-only`, `--personal-only`, `--show-passwords`, and `--key=value` forms) with typed parse errors.
- Implemented command execution flow that calls `KeychainManager.listPasswords(matching:)`, applies shared/personal/search filtering, and renders output through `OutputFormatter` using the selected style and password visibility flag.
- Added `ListCommand.filteredItems(_:search:sharedOnly:personalOnly:)` for deterministic filtering logic and case-insensitive substring search across service/account/shared group name.
- Wired `list` subcommand dispatch in `Sources/ApplPass/ApplPass.swift` and updated available-command error messaging to include `list`.
- Added `Tests/ApplPassTests/ListCommandTests.swift` coverage for parsing, filtering logic, run behavior, keychain error mapping, and integration with multiple items through a test keychain backend.
- Updated `Tests/ApplPassTests/SmokeTests.swift` to validate updated command error messaging.
- Gotcha: SwiftPM sandboxing is blocked in this environment, so all verification commands must use `--disable-sandbox`.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive .`.

## Iteration 13 — S13-add-command — Add command implementation
Date: 2026-02-14T08:38:11Z
- Added `Sources/ApplPass/Commands/AddCommand.swift` with `AddCommand` conforming to `ParsableCommand`, including options `service`, `account`, `label`, `length` and flags `stdin`, `generate`, `sync`.
- Implemented explicit `add` argument parsing for `-s/--service`, `-a/--account`, `-l/--label`, `-n/--length`, `--stdin`, `-g/--generate`, `--sync`, plus `--key=value` forms with typed parse errors.
- Implemented command execution flow with service/account validation, mutually-exclusive `--stdin`/`--generate` checks, input-source selection (stdin, generated, secure interactive prompt), and keychain insertion via `KeychainManager.addPassword(...)`.
- Added secure interactive password input by disabling terminal echo with `termios`, restoring terminal settings on exit, and emitting a user-facing TTY guidance error when interactive input is unavailable.
- Added `Tests/ApplPassTests/AddCommandTests.swift` coverage for parsing, stdin input handling, interactive input path, generate/length integration, conflict and validation errors, keychain/generator error mapping, and add→get integration behavior.
- Wired `add` subcommand dispatch in `Sources/ApplPass/ApplPass.swift` and updated `Tests/ApplPassTests/SmokeTests.swift` available-command messaging to include `add`.
- Gotcha: this repo’s vendored argument-parser metadata wrappers support only a single `@Option(name:)` value, so short aliases are handled in explicit parser logic while wrapper annotations remain metadata-only.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive .`.

## Iteration 14 — S14-update-command — Update command implementation
Date: 2026-02-14T08:47:13Z
- Added `Sources/ApplPass/Commands/UpdateCommand.swift` with `UpdateCommand` conforming to `ParsableCommand`, including `service`/`account` options, `stdin`/`generate`/`force` flags, and `length` option for generated passwords.
- Implemented explicit `update` argument parsing for `-s/--service`, `-a/--account`, `-n/--length`, `--stdin`, `-g/--generate`, `--force`, and `--key=value` forms with typed parse errors.
- Implemented command execution flow with required option validation, mutually-exclusive `--stdin`/`--generate` checks, input-source selection (stdin, generated, secure interactive prompt), confirmation prompting (unless `--force`), and `KeychainManager.updatePassword(...)` invocation.
- Added `Tests/ApplPassTests/UpdateCommandTests.swift` coverage for parsing, confirmation cancellation behavior, `--force` confirmation bypass, input-mode behavior, keychain/confirmation error mapping, and serialized integration update behavior.
- Wired `update` subcommand dispatch in `Sources/ApplPass/ApplPass.swift` and updated `Tests/ApplPassTests/SmokeTests.swift` available-command messaging to include `update`.
- Gotcha: interactive confirmation and interactive password entry both require a TTY; `--force` skips confirmation for non-interactive automation flows.
- Verification passed: `swift build --disable-sandbox`, `swift build -c release --disable-sandbox`, `swift test --disable-sandbox --verbose`, `swift format lint --recursive .`.
